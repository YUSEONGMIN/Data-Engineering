### [전체 목차](../../README.md)
### [이전 페이지](../README.md)

# 7 일차
크롤링

`Selenium`

## 목차

- [Selenium](#selenium)

## [Selenium](#목차)

- **웹 브라우저 제어 도구**
    - 원래는 웹 어플리케이션 자동 테스트를 위한 목적으로 만들어진 프레임워크.
    - 웹브라우저를 프로그램을 이용해 제어할 수 있다.
- **requests 모듈의 한계**   
    - Javascript를 이용한 AJAX 기법의 비동기적 요청 처리 페이지 크롤링이 힘들다.
    - 로그인 후 요청이 가능한 페이지들에 대한 크롤링이 번거롭다.
    - Selenium을 활용하면 이 두가지 모두 쉽게 처리할 수 있다.
    
- **Selenium 단점** 
    - 속도가 느림

- [튜토리얼](https://selenium-python.readthedocs.io/)
> - 주의: selenium은 3에서 4버전으로 업그레이드 되면서 드라이버 설정과 element 조회 메서드등이 많이 바뀜.
#  !터미널 명령어
!pip install selenium
# Driver

- Driver 
    - 웹브라우저를 제어하는 프로그램으로 웹 브라우저별로 제공된다.
    - Selenium 패키지의 Driver객체를 이용해 제어하게 된다.
    
## 설치
1. **DriverManager 이용**
    - `pip install webdriver-manager` 
2. **Hard coding**
    1. 브라우져별로 드라이버를 다운로드 받는다.
        - https://www.selenium.dev/documentation/webdriver/getting_started/install_drivers/#quick-reference
    2. Local 컴퓨터에 설치된 크롬브라우져 버전에 맞는 드라이버 선택

### DriverManager를 이용해 WebDriver 생성
!pip install webdriver-manager
### 다운 받은 Driver이용해 WebDriver생성
# from webdriver_manager.chrome import ChromeDriverManager
from webdriver_manager.microsoft import EdgeChromiumDriverManager
# from selenium.webdriver.chrome.service import Service
from selenium.webdriver.edge.service import Service
from selenium import webdriver

# driver를 다운로드 받기
# driver = ChromeDriverManager()
driver = EdgeChromiumDriverManager().install() # 다운받은 경로를 반환
print(driver)
service = Service(executable_path=driver) # driver 경로를 넣어서 생성
# browser = webdriver.Chrome(service=service)
browser = webdriver.Edge(service=service)
print(type(browser)) # 웹브라우저(크롬/엣지)을 관리하는 객체
browser.get("https://www.naver.com")
# browser.get("https://www.daum.net")
browser.close() # 끄기
## WebDriver 주요 속성/메소드

- **page_source** : 현재 페이지의 html 소스를 반환
    - page_source로 html을 받아서 BeautifulSoup으로 크롤링할 원소를 찾을 수 있다.
- **get_screenshot_as_file(파일경로)**
    - 현재 웹브라우저 화면을 지정한 캡처해서 지정한 파일 경로에 저장한다.
- **set_window_size(width, height)**
    - 웹브라우저 윈도우 크기 조정
- **maximize_window()**
    - 웹브라우저 화면 최대 크기로 만들기.
- **get_window_size()**
    - 웹브라우저 윈도우 크기 조회. (width, height)
- **execute_script("자바스크립트코드")**
    - 문자열로 전달한 **javascript 코드**를 실행시킨다.
- **quit()**, **close()**
    - 웹브라우저를 종료한다.
    
## Page의 Element 조회 메소드
- BeautifulSoup을 이용하지 않고 셀레늄 자체 parser를 이용할 수 있다.
- **find_element()**: 조건을 만족하는 첫번째 요소를 반환한다.
    - 매개변수
        - **by**: 검색방식
            - **By.ID**
            - **By.CLASS_NAME**
            - **By.TAG_NAME**
            - **By.CSS_SELECTOR**
            - **By.XPATH**
            - **By.LINK_TEXT**
            - **By.PARTIAL_LINK_TEXT**
        - **value**: str - 검색조건
    - 반환타입: **WebElement**
- **find_elements()**: 조건을 만족하는 모든 요소를 찾는다.
    - 매개변수: find_element()와 동일
    - 반환타입
        - **list of WebElement**       
### WebElement (조회결과) 메소드 / 속성
- 메소드
    - **get_attribute('속성명')**: 태그의 속성값 조회
    - **send_keys("문자열")**: 입력폼에 문자열 값을 입력.
    - **click()**: element를 클릭
    - **submit()**: element가 Form인 경우 폼 전송
    - **clear()**: element가 입력폼인 경우 텍스트를 지운다.
    - 위 조회 메소드들 : 하위의 elements들 조회
- 속성
    - **text**: 태그내의 텍스트
    - **tag_name**: 태그이름 
from webdriver_manager.microsoft import EdgeChromiumDriverManager
from selenium import webdriver
from selenium.webdriver.edge.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
# web browser(크롬/엣지)을 실행
service = Service(executable_path=driver)
browser = webdriver.Edge(service=service)

# url로 이동 (naver)
browser.get("https://www.naver.com")
# html 소스코드를 조회 -> BeautifulSoup 이용해서 데이터 추출
html = browser.page_source
print(html[:1000])
# 화면 크기를 최대화
browser.maximize_window()
# 화면 캡쳐
browser.get_screenshot_as_file("naver_main.png")
browser.set_window_size(1000, 500)
browser.get_window_size()
textfield = browser.find_element(By.ID, "query")
print(type(textfield))
print(textfield.tag_name, textfield.get_attribute("name"))
# 키보드 입력 -> 글자들을 입력
textfield.clear()
textfield.send_keys("날씨")
textfield.send_keys(Keys.ENTER)
textfield2 = browser.find_element(By.ID, "nx_query")
textfield2.clear()
textfield2.send_keys("미세먼지")
submit_btn = browser.find_element(By.CLASS_NAME, "bt_search")
print(submit_btn.tag_name)
submit_btn.click()
browser.close()
## TODO: 구글 검색
1. https://www.google.co.kr 페이지로 이동
2. 파이썬을 검색한다.
3. 검색결과 title들을 출력한다.
from webdriver_manager.microsoft import EdgeChromiumDriverManager
from selenium import webdriver
from selenium.webdriver.edge.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys

from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
option = webdriver.EdgeOptions()
option.add_argument("--headless")

driver = EdgeChromiumDriverManager().install()
service = Service(executable_path=driver)
browser = webdriver.Edge(service=service) # 브라우저 띄우기
# 구글 이동
browser.get("https://www.google.co.kr/")
# 키워드 입력필드를 조회
keyword_tf = browser.find_element(By.ID, "APjFqb") #(By.NAME, 'q')
# 검색 키워드 입력
keyword_tf.send_keys("python")
keyword_tf.send_keys(Keys.ENTER)

# import time
# time.sleep(5)
# title_list = browser.find_elements(By.CSS_SELECTOR, ".LC20lb.MBeuO.DKV0Md")

# element를 가져올 수 있을 때까지 10초까지 대기
title_list = WebDriverWait(browser, 10).until(
    EC.presence_of_all_elements_located((By.CSS_SELECTOR, ".LC20lb.MBeuO.DKV0Md"))
)

## EC.presence_of_all_elements_located = find_elements()
## EC.presence_of_element_located = find_element()

print(len(title_list))
for tag in title_list:
    print(tag.text)
browser.close()
## 브라우저의 headless 모드를 이용.
- Headless 브라우저 
    - 브라우저의 창을 띄우지 않고 실제 브라우저와 동일하게 동작하도록 하는 방식
    - CLI 기반의 OS (리눅스 서버)를 지원하기 위한 브라우저
    - 크롬은 버전 60부터 headless 모드 지원
- selenium에서 headless 모드
    - webdriver options에 headless 설정
# option = webdriver.ChromeOptions()
option = webdriver.EdgeOptions()
option.add_argument("--headless")

service = Service(executable_path=driver)
browser = webdriver.Edge(service=service, options=option)

browser.get("https://www.naver.com")
browser.get_screenshot_as_file("page_image.png")
browser.close()
# 대기 하기

## Explicit Wait
- 특정 조건/상황을 만족할 때 까지 대기
- `WebDriverWait(driver, 초).until(expected_contition)` 구문 사용
- expected_condition 함수
     - selenium.webdriver.support.expected_conditions 모듈에 정의된 함수 사용.
         - https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.support.expected_conditions
     
## Implicit Wait
- 현재 페이지에 없는 element나 elememt들이 loading 되기를 설정한 시간만큼 기다린다. 
- 설정한 시간 이내에 elements가 loading되면 대기가 종료된다.
- `implicit_wait(초)` 구문 사용
- 한번 설정하면 설정된 WebDriver가 close될때 까지 그 설정이 유지된다.
- https://selenium-python.readthedocs.io/waits.html

### 예)
```python
driver.implicitly_wait(5) 
# 페이지 로딩(dom tree완성)될 때까지 최대 5초간 기다린다. (로딩이 되면 5초가 되지 않아도 대기를 끝낸다.)
```
<hr>

```python
from selenium.webdriver.support import expected_conditions as EC

...

try:
    # element가 반환될 때 까지 최대 10초 기다린다.
    element = WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.ID, "myDynamicElement"))
    )
finally:
    driver.quit()
```





### [목차로 돌아가기](#목차)
## [이전 페이지](../README.md)
